# Comparing database rows before and after with SQLite JSON functions

Here's a trick I've been using to compare the rows in a table before and after I perform an operation against it. It works well for a few hundred (and maybe a few thousand) rows.

First, get hold of a copy of the primary keys (or some other unique column) in the existing table, as JSON.

```sql
select json_group_array(id) from mytable
```

This will return a JSON string, which you can copy and paste somewhere.

I ran it against my [repos](https://ripgrep.datasette.io/repos/repos) table here to select repo names, like this:

```sql
select json_group_array(full_name) from repos
```
[Try that here](https://ripgrep.datasette.io/repos?sql=select+json_group_array%28full_name%29+from+repos).

Here's the result of that query as a very long string:

`["simonw/datasette","simonw/csvs-to-sqlite","simonw/datasette-plugin-demos","simonw/datasette-cluster-map","simonw/register-of-members-interests-datasette","simonw/fivethirtyeight-datasette","simonw/global-power-plants-datasette","simonw/datasette-sql-scraper","simonw/datasette-leaflet-geojson","simonw/datasette-registry","simonw/datasette-vega","simonw/sqlite-utils","simonw/russian-ira-facebook-ads-datasette","simonw/datasette-json-html","simonw/russian-troll-tweets-datasette","simonw/datasette-render-images","simonw/datasette-small","simonw/24ways-datasette","simonw/sqlite-fts4","simonw/datasette-sqlite-fts4","simonw/db-to-sqlite","simonw/datasette-pretty-json","simonw/markdown-to-sqlite","simonw/dbf-to-sqlite","simonw/whosonfirst-datasette","simonw/datasette-car-2019","simonw/datasette-jellyfish","simonw/yaml-to-sqlite","simonw/datasette-render-html","simonw/datasette-jq","simonw/datasette-bplist","simonw/datasette-render-binary","simonw/fara-datasette","simonw/datasette-auth-github","simonw/sqlite-diffable","simonw/datasette-cors","dogsheep/dogsheep-beta","dogsheep/healthkit-to-sqlite","dogsheep/swarm-to-sqlite","dogsheep/twitter-to-sqlite","dogsheep/inaturalist-to-sqlite","dogsheep/google-takeout-to-sqlite","dogsheep/github-to-sqlite","simonw/datasette-rure","simonw/datasette-atom","dogsheep/genome-to-sqlite","dogsheep/pocket-to-sqlite","simonw/datasette-render-timestamps","dogsheep/dogsheep.github.io","simonw/museums","simonw/datasette-haversine","simonw/sqlite-transform","simonw/datasette-csvs","simonw/datasette-render-markdown","simonw/datasette-template-sql","simonw/asgi-log-to-sqlite","simonw/datasette-configure-asgi","simonw/datasette-upload-csvs","simonw/datasette-auth-existing-cookies","simonw/datasette-sentry","simonw/geojson-to-sqlite","simonw/datasette-debug-asgi","simonw/shapefile-to-sqlite","simonw/datasette-mask-columns","simonw/datasette-ics","simonw/datasette-configure-fts","simonw/fec-to-sqlite","simonw/datasette-search-all","simonw/datasette-column-inspect","simonw/covid-19-datasette","simonw/datasette-edit-schema","simonw/datasette-publish-fly","dogsheep/hacker-news-to-sqlite","simonw/datasette-show-errors","simonw/datasette-publish-vercel","simonw/big-local-datasette","simonw/datasette-clone","dogsheep/dogsheep-photos","simonw/til","simonw/datasette-media","simonw/datasette-permissions-sql","simonw/datasette-auth-tokens","simonw/datasette-psutil","simonw/datasette-plugin","simonw/datasette-plugin-template-demo","simonw/datasette-saved-queries","simonw/datasette.io","simonw/sqlite-generate","simonw/datasette-block-robots","simonw/datasette-glitch","simonw/datasette-init","simonw/datasette-write","simonw/datasette-allow-permissions-debug","simonw/sba-loans-covid-19-datasette","simonw/datasette-auth-passwords","simonw/srccon-2020-datasette","simonw/datasette-insert","simonw/datasette-copyable","simonw/datasette-insert-unsafe","simonw/datasette-graphql","simonw/parlgov-datasette","simonw/homebrew-datasette","simonw/datasette-io-redirect","simonw/datasette-schema-versions","simonw/calands-datasette","simonw/datasette-yaml","simonw/datasette-backup","simonw/sqlite-dump","simonw/datasette-dns","simonw/datasette-seaborn","simonw/sqlite-fts5-trigram","simonw/datasette-dateutil","simonw/datasette-import-table","simonw/buildpack-datasette","simonw/datasette-json-preview","dogsheep/evernote-to-sqlite","simonw/sphinx-to-sqlite","simonw/datasette-edit-templates","simonw/datasette-indieauth","simonw/datasette-ripgrep","simonw/datasette-css-properties","simonw/datasette-export-notebook","simonw/cbsa-datasette","simonw/datasette-leaflet-freedraw","simonw/datasette-leaflet","simonw/datasette-basemap","simonw/datasette-tiles","simonw/vaccinate-ca-datasette","simonw/datasette-block","simonw/us-counties-datasette","simonw/tableau-to-sqlite","simonw/django-sql-dashboard","simonw/iam-to-sqlite","simonw/azure-functions-datasette","simonw/datasette-publish-azure","simonw/datasette-placekey","simonw/datasette-remote-metadata","simonw/datasette-pyinstrument","simonw/datasette-query-links","simonw/datasette-x-forwarded-host","simonw/datasette-app","simonw/datasette-verify","simonw/datasette-plugin-template-repository","simonw/datasette-plugin-template-repository-demo-old","simonw/datasette-statistics","simonw/datasette-notebook","simonw/datasette-template-request","simonw/datasette-hello-world","simonw/datasette-jupyterlite","simonw/iam-definitions-datasette","simonw/datasette-redirect-to-https","simonw/datasette-table","simonw/datasette-hovercards","simonw/datasette-pretty-traces","simonw/datasette-tiddlywiki","simonw/google-drive-to-sqlite","simonw/datasette-redirect-forbidden","simonw/congress-legislators-datasette","simonw/datasette-hashed-urls","simonw/datasette-plugin-template-repository-demo","simonw/datasette-packages","simonw/datasette-auth0","simonw/pypi-to-sqlite","simonw/datasette-total-page-time","simonw/datasette-gzip","simonw/datasette-copy-to-memory","simonw/datasette-lite","simonw/datasette-upload-dbs","simonw/datasette-screenshots","simonw/google-calendar-to-sqlite","simonw/datasette-unsafe-expose-env","simonw/mbox-to-sqlite","simonw/datasette-socrata","simonw/datasette-low-disk-space-hook","simonw/datasette-scale-to-zero"]`

Now, run the update operation - or maybe you have another table somewhere else you want to compare with, which will work fine too.

To run the comparison, construct the following query:

```sql
select id from mytable where id not in (
  select value from json_each(:previous_value)
)
```
Paste the JSON string (wrapped in single quotes) into the :previous_value parameter.

Here's what `select value from json_each('["a","b","c"]')` returns:

| value |
|-------|
| a     |
| b     |
| c     |

You can use this table in a sub-select, to return rows that now exist which did not exist before.

[Try my huge query here](https://ripgrep.datasette.io/repos?sql=select%0D%0A++full_name%0D%0Afrom%0D%0A++repos%0D%0Awhere%0D%0A++full_name+not+in+%28%0D%0A++++select%0D%0A++++++value%0D%0A++++from%0D%0A++++++json_each%28%0D%0A++++++++%27%5B%22simonw%2Fdatasette%22%2C%22simonw%2Fcsvs-to-sqlite%22%2C%22simonw%2Fdatasette-plugin-demos%22%2C%22simonw%2Fdatasette-cluster-map%22%2C%22simonw%2Fregister-of-members-interests-datasette%22%2C%22simonw%2Ffivethirtyeight-datasette%22%2C%22simonw%2Fglobal-power-plants-datasette%22%2C%22simonw%2Fdatasette-sql-scraper%22%2C%22simonw%2Fdatasette-leaflet-geojson%22%2C%22simonw%2Fdatasette-registry%22%2C%22simonw%2Fdatasette-vega%22%2C%22simonw%2Fsqlite-utils%22%2C%22simonw%2Frussian-ira-facebook-ads-datasette%22%2C%22simonw%2Fdatasette-json-html%22%2C%22simonw%2Frussian-troll-tweets-datasette%22%2C%22simonw%2Fdatasette-render-images%22%2C%22simonw%2Fdatasette-small%22%2C%22simonw%2F24ways-datasette%22%2C%22simonw%2Fsqlite-fts4%22%2C%22simonw%2Fdatasette-sqlite-fts4%22%2C%22simonw%2Fdb-to-sqlite%22%2C%22simonw%2Fdatasette-pretty-json%22%2C%22simonw%2Fmarkdown-to-sqlite%22%2C%22simonw%2Fdbf-to-sqlite%22%2C%22simonw%2Fwhosonfirst-datasette%22%2C%22simonw%2Fdatasette-car-2019%22%2C%22simonw%2Fdatasette-jellyfish%22%2C%22simonw%2Fyaml-to-sqlite%22%2C%22simonw%2Fdatasette-render-html%22%2C%22simonw%2Fdatasette-jq%22%2C%22simonw%2Fdatasette-bplist%22%2C%22simonw%2Fdatasette-render-binary%22%2C%22simonw%2Ffara-datasette%22%2C%22simonw%2Fdatasette-auth-github%22%2C%22simonw%2Fsqlite-diffable%22%2C%22simonw%2Fdatasette-cors%22%2C%22dogsheep%2Fdogsheep-beta%22%2C%22dogsheep%2Fhealthkit-to-sqlite%22%2C%22dogsheep%2Fswarm-to-sqlite%22%2C%22dogsheep%2Ftwitter-to-sqlite%22%2C%22dogsheep%2Finaturalist-to-sqlite%22%2C%22dogsheep%2Fgoogle-takeout-to-sqlite%22%2C%22dogsheep%2Fgithub-to-sqlite%22%2C%22simonw%2Fdatasette-rure%22%2C%22simonw%2Fdatasette-atom%22%2C%22dogsheep%2Fgenome-to-sqlite%22%2C%22dogsheep%2Fpocket-to-sqlite%22%2C%22simonw%2Fdatasette-render-timestamps%22%2C%22dogsheep%2Fdogsheep.github.io%22%2C%22simonw%2Fmuseums%22%2C%22simonw%2Fdatasette-haversine%22%2C%22simonw%2Fsqlite-transform%22%2C%22simonw%2Fdatasette-csvs%22%2C%22simonw%2Fdatasette-render-markdown%22%2C%22simonw%2Fdatasette-template-sql%22%2C%22simonw%2Fasgi-log-to-sqlite%22%2C%22simonw%2Fdatasette-configure-asgi%22%2C%22simonw%2Fdatasette-upload-csvs%22%2C%22simonw%2Fdatasette-auth-existing-cookies%22%2C%22simonw%2Fdatasette-sentry%22%2C%22simonw%2Fgeojson-to-sqlite%22%2C%22simonw%2Fdatasette-debug-asgi%22%2C%22simonw%2Fshapefile-to-sqlite%22%2C%22simonw%2Fdatasette-mask-columns%22%2C%22simonw%2Fdatasette-ics%22%2C%22simonw%2Fdatasette-configure-fts%22%2C%22simonw%2Ffec-to-sqlite%22%2C%22simonw%2Fdatasette-search-all%22%2C%22simonw%2Fdatasette-column-inspect%22%2C%22simonw%2Fcovid-19-datasette%22%2C%22simonw%2Fdatasette-edit-schema%22%2C%22simonw%2Fdatasette-publish-fly%22%2C%22dogsheep%2Fhacker-news-to-sqlite%22%2C%22simonw%2Fdatasette-show-errors%22%2C%22simonw%2Fdatasette-publish-vercel%22%2C%22simonw%2Fbig-local-datasette%22%2C%22simonw%2Fdatasette-clone%22%2C%22dogsheep%2Fdogsheep-photos%22%2C%22simonw%2Ftil%22%2C%22simonw%2Fdatasette-media%22%2C%22simonw%2Fdatasette-permissions-sql%22%2C%22simonw%2Fdatasette-auth-tokens%22%2C%22simonw%2Fdatasette-psutil%22%2C%22simonw%2Fdatasette-plugin%22%2C%22simonw%2Fdatasette-plugin-template-demo%22%2C%22simonw%2Fdatasette-saved-queries%22%2C%22simonw%2Fdatasette.io%22%2C%22simonw%2Fsqlite-generate%22%2C%22simonw%2Fdatasette-block-robots%22%2C%22simonw%2Fdatasette-glitch%22%2C%22simonw%2Fdatasette-init%22%2C%22simonw%2Fdatasette-write%22%2C%22simonw%2Fdatasette-allow-permissions-debug%22%2C%22simonw%2Fsba-loans-covid-19-datasette%22%2C%22simonw%2Fdatasette-auth-passwords%22%2C%22simonw%2Fsrccon-2020-datasette%22%2C%22simonw%2Fdatasette-insert%22%2C%22simonw%2Fdatasette-copyable%22%2C%22simonw%2Fdatasette-insert-unsafe%22%2C%22simonw%2Fdatasette-graphql%22%2C%22simonw%2Fparlgov-datasette%22%2C%22simonw%2Fhomebrew-datasette%22%2C%22simonw%2Fdatasette-io-redirect%22%2C%22simonw%2Fdatasette-schema-versions%22%2C%22simonw%2Fcalands-datasette%22%2C%22simonw%2Fdatasette-yaml%22%2C%22simonw%2Fdatasette-backup%22%2C%22simonw%2Fsqlite-dump%22%2C%22simonw%2Fdatasette-dns%22%2C%22simonw%2Fdatasette-seaborn%22%2C%22simonw%2Fsqlite-fts5-trigram%22%2C%22simonw%2Fdatasette-dateutil%22%2C%22simonw%2Fdatasette-import-table%22%2C%22simonw%2Fbuildpack-datasette%22%2C%22simonw%2Fdatasette-json-preview%22%2C%22dogsheep%2Fevernote-to-sqlite%22%2C%22simonw%2Fsphinx-to-sqlite%22%2C%22simonw%2Fdatasette-edit-templates%22%2C%22simonw%2Fdatasette-indieauth%22%2C%22simonw%2Fdatasette-ripgrep%22%2C%22simonw%2Fdatasette-css-properties%22%2C%22simonw%2Fdatasette-export-notebook%22%2C%22simonw%2Fcbsa-datasette%22%2C%22simonw%2Fdatasette-leaflet-freedraw%22%2C%22simonw%2Fdatasette-leaflet%22%2C%22simonw%2Fdatasette-basemap%22%2C%22simonw%2Fdatasette-tiles%22%2C%22simonw%2Fvaccinate-ca-datasette%22%2C%22simonw%2Fdatasette-block%22%2C%22simonw%2Fus-counties-datasette%22%2C%22simonw%2Ftableau-to-sqlite%22%2C%22simonw%2Fdjango-sql-dashboard%22%2C%22simonw%2Fiam-to-sqlite%22%2C%22simonw%2Fazure-functions-datasette%22%2C%22simonw%2Fdatasette-publish-azure%22%2C%22simonw%2Fdatasette-placekey%22%2C%22simonw%2Fdatasette-remote-metadata%22%2C%22simonw%2Fdatasette-pyinstrument%22%2C%22simonw%2Fdatasette-query-links%22%2C%22simonw%2Fdatasette-x-forwarded-host%22%2C%22simonw%2Fdatasette-app%22%2C%22simonw%2Fdatasette-verify%22%2C%22simonw%2Fdatasette-plugin-template-repository%22%2C%22simonw%2Fdatasette-plugin-template-repository-demo-old%22%2C%22simonw%2Fdatasette-statistics%22%2C%22simonw%2Fdatasette-notebook%22%2C%22simonw%2Fdatasette-template-request%22%2C%22simonw%2Fdatasette-hello-world%22%2C%22simonw%2Fdatasette-jupyterlite%22%2C%22simonw%2Fiam-definitions-datasette%22%2C%22simonw%2Fdatasette-redirect-to-https%22%2C%22simonw%2Fdatasette-table%22%2C%22simonw%2Fdatasette-hovercards%22%2C%22simonw%2Fdatasette-pretty-traces%22%2C%22simonw%2Fdatasette-tiddlywiki%22%2C%22simonw%2Fgoogle-drive-to-sqlite%22%2C%22simonw%2Fdatasette-redirect-forbidden%22%2C%22simonw%2Fcongress-legislators-datasette%22%2C%22simonw%2Fdatasette-hashed-urls%22%2C%22simonw%2Fdatasette-plugin-template-repository-demo%22%2C%22simonw%2Fdatasette-packages%22%2C%22simonw%2Fdatasette-auth0%22%2C%22simonw%2Fpypi-to-sqlite%22%2C%22simonw%2Fdatasette-total-page-time%22%2C%22simonw%2Fdatasette-gzip%22%2C%22simonw%2Fdatasette-copy-to-memory%22%2C%22simonw%2Fdatasette-lite%22%2C%22simonw%2Fdatasette-upload-dbs%22%2C%22simonw%2Fdatasette-screenshots%22%2C%22simonw%2Fgoogle-calendar-to-sqlite%22%2C%22simonw%2Fdatasette-unsafe-expose-env%22%2C%22simonw%2Fmbox-to-sqlite%22%2C%22simonw%2Fdatasette-socrata%22%2C%22simonw%2Fdatasette-low-disk-space-hook%22%2C%22simonw%2Fdatasette-scale-to-zero%22%5D%27%0D%0A++++++%29%0D%0A++%29) - the SQL I ran is this:

```sql
select
  full_name
from
  repos
where
  full_name not in (
    select
      value
    from
      json_each(
        '["simonw/datasette","simonw/csvs-to-sqlite","simonw/datasette-plugin-demos","simonw/datasette-cluster-map","simonw/register-of-members-interests-datasette","simonw/fivethirtyeight-datasette","simonw/global-power-plants-datasette","simonw/datasette-sql-scraper","simonw/datasette-leaflet-geojson","simonw/datasette-registry","simonw/datasette-vega","simonw/sqlite-utils","simonw/russian-ira-facebook-ads-datasette","simonw/datasette-json-html","simonw/russian-troll-tweets-datasette","simonw/datasette-render-images","simonw/datasette-small","simonw/24ways-datasette","simonw/sqlite-fts4","simonw/datasette-sqlite-fts4","simonw/db-to-sqlite","simonw/datasette-pretty-json","simonw/markdown-to-sqlite","simonw/dbf-to-sqlite","simonw/whosonfirst-datasette","simonw/datasette-car-2019","simonw/datasette-jellyfish","simonw/yaml-to-sqlite","simonw/datasette-render-html","simonw/datasette-jq","simonw/datasette-bplist","simonw/datasette-render-binary","simonw/fara-datasette","simonw/datasette-auth-github","simonw/sqlite-diffable","simonw/datasette-cors","dogsheep/dogsheep-beta","dogsheep/healthkit-to-sqlite","dogsheep/swarm-to-sqlite","dogsheep/twitter-to-sqlite","dogsheep/inaturalist-to-sqlite","dogsheep/google-takeout-to-sqlite","dogsheep/github-to-sqlite","simonw/datasette-rure","simonw/datasette-atom","dogsheep/genome-to-sqlite","dogsheep/pocket-to-sqlite","simonw/datasette-render-timestamps","dogsheep/dogsheep.github.io","simonw/museums","simonw/datasette-haversine","simonw/sqlite-transform","simonw/datasette-csvs","simonw/datasette-render-markdown","simonw/datasette-template-sql","simonw/asgi-log-to-sqlite","simonw/datasette-configure-asgi","simonw/datasette-upload-csvs","simonw/datasette-auth-existing-cookies","simonw/datasette-sentry","simonw/geojson-to-sqlite","simonw/datasette-debug-asgi","simonw/shapefile-to-sqlite","simonw/datasette-mask-columns","simonw/datasette-ics","simonw/datasette-configure-fts","simonw/fec-to-sqlite","simonw/datasette-search-all","simonw/datasette-column-inspect","simonw/covid-19-datasette","simonw/datasette-edit-schema","simonw/datasette-publish-fly","dogsheep/hacker-news-to-sqlite","simonw/datasette-show-errors","simonw/datasette-publish-vercel","simonw/big-local-datasette","simonw/datasette-clone","dogsheep/dogsheep-photos","simonw/til","simonw/datasette-media","simonw/datasette-permissions-sql","simonw/datasette-auth-tokens","simonw/datasette-psutil","simonw/datasette-plugin","simonw/datasette-plugin-template-demo","simonw/datasette-saved-queries","simonw/datasette.io","simonw/sqlite-generate","simonw/datasette-block-robots","simonw/datasette-glitch","simonw/datasette-init","simonw/datasette-write","simonw/datasette-allow-permissions-debug","simonw/sba-loans-covid-19-datasette","simonw/datasette-auth-passwords","simonw/srccon-2020-datasette","simonw/datasette-insert","simonw/datasette-copyable","simonw/datasette-insert-unsafe","simonw/datasette-graphql","simonw/parlgov-datasette","simonw/homebrew-datasette","simonw/datasette-io-redirect","simonw/datasette-schema-versions","simonw/calands-datasette","simonw/datasette-yaml","simonw/datasette-backup","simonw/sqlite-dump","simonw/datasette-dns","simonw/datasette-seaborn","simonw/sqlite-fts5-trigram","simonw/datasette-dateutil","simonw/datasette-import-table","simonw/buildpack-datasette","simonw/datasette-json-preview","dogsheep/evernote-to-sqlite","simonw/sphinx-to-sqlite","simonw/datasette-edit-templates","simonw/datasette-indieauth","simonw/datasette-ripgrep","simonw/datasette-css-properties","simonw/datasette-export-notebook","simonw/cbsa-datasette","simonw/datasette-leaflet-freedraw","simonw/datasette-leaflet","simonw/datasette-basemap","simonw/datasette-tiles","simonw/vaccinate-ca-datasette","simonw/datasette-block","simonw/us-counties-datasette","simonw/tableau-to-sqlite","simonw/django-sql-dashboard","simonw/iam-to-sqlite","simonw/azure-functions-datasette","simonw/datasette-publish-azure","simonw/datasette-placekey","simonw/datasette-remote-metadata","simonw/datasette-pyinstrument","simonw/datasette-query-links","simonw/datasette-x-forwarded-host","simonw/datasette-app","simonw/datasette-verify","simonw/datasette-plugin-template-repository","simonw/datasette-plugin-template-repository-demo-old","simonw/datasette-statistics","simonw/datasette-notebook","simonw/datasette-template-request","simonw/datasette-hello-world","simonw/datasette-jupyterlite","simonw/iam-definitions-datasette","simonw/datasette-redirect-to-https","simonw/datasette-table","simonw/datasette-hovercards","simonw/datasette-pretty-traces","simonw/datasette-tiddlywiki","simonw/google-drive-to-sqlite","simonw/datasette-redirect-forbidden","simonw/congress-legislators-datasette","simonw/datasette-hashed-urls","simonw/datasette-plugin-template-repository-demo","simonw/datasette-packages","simonw/datasette-auth0","simonw/pypi-to-sqlite","simonw/datasette-total-page-time","simonw/datasette-gzip","simonw/datasette-copy-to-memory","simonw/datasette-lite","simonw/datasette-upload-dbs","simonw/datasette-screenshots","simonw/google-calendar-to-sqlite","simonw/datasette-unsafe-expose-env","simonw/mbox-to-sqlite","simonw/datasette-socrata","simonw/datasette-low-disk-space-hook","simonw/datasette-scale-to-zero"]'
      )
  )
```
